<!DOCTYPE html>
<html lang="ur" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0b1a0f">
<meta name="robots" content="noindex, nofollow, noarchive">
<title>Hamara Ghar ğŸ¡</title>
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#060e08;--bg2:#0b1a0f;--surface:#0f2214;--surface2:#152b1a;--surface3:#1a3320;
  --border:rgba(212,175,55,0.15);--border2:rgba(212,175,55,0.32);
  --gold:#d4af37;--gold-lt:#f0d060;--gold-dk:#a8860a;
  --emerald:#2ecc71;--emerald-dk:#1a8a4a;
  --text:#f5ede0;--text-muted:#8a9e8d;--red:#e05555;--blue:#48cae4;
  --radius:14px;--shadow:0 12px 48px rgba(0,0,0,0.6);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:radial-gradient(ellipse 70% 50% at 15% 20%,rgba(46,204,113,0.07) 0%,transparent 60%),
  radial-gradient(ellipse 60% 70% at 85% 75%,rgba(212,175,55,0.06) 0%,transparent 60%);}
body::after{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background-image:repeating-linear-gradient(45deg,rgba(212,175,55,0.018) 0px,rgba(212,175,55,0.018) 1px,transparent 1px,transparent 42px),
  repeating-linear-gradient(-45deg,rgba(212,175,55,0.018) 0px,rgba(212,175,55,0.018) 1px,transparent 1px,transparent 42px);}
.view{display:none;position:relative;z-index:1;}
.view.active{display:flex;}

/* â•â• SETUP WIZARD â•â• */
#setupView{min-height:100vh;align-items:center;justify-content:center;padding:24px;flex-direction:column;}
.setup-card{background:linear-gradient(145deg,var(--surface),var(--surface2));border:1px solid var(--border);border-radius:24px;padding:40px 36px;width:100%;max-width:500px;box-shadow:var(--shadow);}
.setup-step{display:none;}.setup-step.active{display:block;}
.step-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(212,175,55,0.12);border:1px solid var(--border2);color:var(--gold);padding:5px 12px;border-radius:20px;font-size:11px;font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:20px;}
.setup-title{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:700;color:var(--gold-lt);margin-bottom:8px;}
.setup-desc{font-size:13px;color:var(--text-muted);line-height:1.7;margin-bottom:24px;}
.setup-desc a{color:var(--blue);text-decoration:none;}
.setup-desc a:hover{text-decoration:underline;}
.info-box{background:rgba(72,202,228,0.06);border:1px solid rgba(72,202,228,0.2);border-radius:12px;padding:14px 16px;margin-bottom:20px;font-size:13px;line-height:1.7;color:var(--text-muted);}
.info-box strong{color:var(--blue);}
.warn-box{background:rgba(212,175,55,0.06);border:1px solid rgba(212,175,55,0.2);border-radius:12px;padding:14px 16px;margin-bottom:20px;font-size:13px;line-height:1.7;color:var(--text-muted);}
.warn-box strong{color:var(--gold);}
.step-num{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.step-num .sn{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,var(--gold-dk),var(--gold));color:#060e08;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.step-num span{font-size:13px;font-weight:500;}
.code-box{background:var(--bg);border:1px solid var(--border2);border-radius:8px;padding:10px 14px;font-family:monospace;font-size:13px;color:var(--gold-lt);margin:8px 0;word-break:break-all;}

/* â•â• MEMBER SELECT â•â• */
#memberView{min-height:100vh;align-items:center;justify-content:center;flex-direction:column;padding:24px;}
.welcome-header{text-align:center;margin-bottom:44px;animation:fadeDown 0.8s cubic-bezier(0.16,1,0.3,1) both;}
@keyframes fadeDown{from{opacity:0;transform:translateY(-20px);}to{opacity:1;transform:translateY(0);}}
.brand-emblem{width:100px;height:100px;border-radius:50%;border:2px solid var(--gold);display:flex;align-items:center;justify-content:center;font-size:44px;margin:0 auto 20px;background:radial-gradient(circle,rgba(212,175,55,0.1) 0%,transparent 70%);box-shadow:0 0 50px rgba(212,175,55,0.15);animation:glowPulse 4s ease-in-out infinite;}
@keyframes glowPulse{0%,100%{box-shadow:0 0 50px rgba(212,175,55,0.15);}50%{box-shadow:0 0 80px rgba(212,175,55,0.3);}}
.brand-title{font-family:'Cormorant Garamond',serif;font-size:40px;font-weight:700;color:var(--gold);letter-spacing:3px;text-shadow:0 0 40px rgba(212,175,55,0.3);}
.brand-urdu{font-size:22px;color:rgba(212,175,55,0.6);margin-top:4px;}
.brand-sub{font-size:11px;color:var(--text-muted);letter-spacing:3px;text-transform:uppercase;margin-top:8px;}
.divider{display:flex;align-items:center;gap:12px;margin:14px auto 0;width:fit-content;}
.divider::before,.divider::after{content:'';width:50px;height:1px;background:linear-gradient(90deg,transparent,var(--gold));}
.divider::after{background:linear-gradient(90deg,var(--gold),transparent);}
.divider span{color:var(--gold);font-size:14px;}
.member-prompt{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:2.5px;color:var(--text-muted);text-align:center;margin-bottom:22px;animation:fadeDown 0.8s 0.2s both;}
.members-grid-sel{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;width:100%;max-width:380px;animation:fadeDown 0.8s 0.3s both;}
.msc{background:linear-gradient(145deg,var(--surface),var(--surface2));border:1px solid var(--border);border-radius:18px;padding:26px 16px;cursor:pointer;transition:all 0.3s cubic-bezier(0.16,1,0.3,1);text-align:center;position:relative;overflow:hidden;}
.msc::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(212,175,55,0.05),rgba(46,204,113,0.05));opacity:0;transition:opacity 0.3s;}
.msc:hover{border-color:var(--border2);transform:translateY(-5px);box-shadow:0 20px 50px rgba(0,0,0,0.5),0 0 25px rgba(212,175,55,0.1);}
.msc:hover::after{opacity:1;}
.msc:active{transform:scale(0.96);}
.msc-av{width:68px;height:68px;border-radius:50%;margin:0 auto 14px;display:flex;align-items:center;justify-content:center;font-size:32px;position:relative;border:1.5px solid rgba(212,175,55,0.4);}
.msc-name{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:600;color:var(--gold-lt);}
.msc-urdu{font-size:14px;color:rgba(212,175,55,0.45);margin:2px 0;}
.msc-role{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1.5px;}
.bismillah{text-align:center;margin-top:32px;font-size:11px;color:rgba(212,175,55,0.22);letter-spacing:3px;animation:fadeDown 0.8s 0.6s both;}

/* â•â• PASSWORD â•â• */
#passwordView{min-height:100vh;align-items:center;justify-content:center;padding:24px;}
.pw-card{background:linear-gradient(145deg,var(--surface),var(--surface2));border:1px solid var(--border);border-radius:24px;padding:44px 36px;width:100%;max-width:400px;box-shadow:var(--shadow),0 0 60px rgba(212,175,55,0.04);animation:slideUp 0.5s cubic-bezier(0.16,1,0.3,1);}
@keyframes slideUp{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}
.pw-back{display:flex;align-items:center;gap:8px;background:none;border:1px solid var(--border);border-radius:10px;padding:9px 16px;color:var(--text-muted);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;cursor:pointer;transition:all 0.2s;margin-bottom:28px;}
.pw-back:hover{border-color:var(--border2);color:var(--gold);}
.pw-user{text-align:center;margin-bottom:28px;}
.pw-avatar{width:82px;height:82px;border-radius:50%;margin:0 auto 14px;display:flex;align-items:center;justify-content:center;font-size:38px;background:linear-gradient(135deg,var(--surface3),var(--surface2));border:2px solid var(--border2);box-shadow:0 0 30px rgba(212,175,55,0.12);}
.pw-name{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:700;color:var(--gold);}
.pw-greet{font-size:13px;color:var(--text-muted);margin-top:4px;}
.pw-dots{display:flex;gap:9px;justify-content:center;margin-bottom:22px;}
.pw-dot{width:11px;height:11px;border-radius:50%;border:1.5px solid var(--border2);background:transparent;transition:all 0.2s;}
.pw-dot.filled{background:var(--gold);border-color:var(--gold);box-shadow:0 0 8px rgba(212,175,55,0.5);}
.pw-lbl{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:2px;color:var(--text-muted);display:block;margin-bottom:8px;}
.pw-wrap{position:relative;margin-bottom:20px;}
.pw-inp{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:15px 48px 15px 16px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:16px;outline:none;transition:border-color 0.2s,box-shadow 0.2s;letter-spacing:4px;}
.pw-inp:focus{border-color:var(--border2);box-shadow:0 0 0 3px rgba(212,175,55,0.08);}
.pw-eye{position:absolute;right:14px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px;}
.pw-eye:hover{color:var(--gold);}
.btn-enter{width:100%;background:linear-gradient(135deg,var(--gold-dk),var(--gold));border:none;border-radius:12px;padding:16px;color:#060e08;font-family:'Plus Jakarta Sans',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;}
.btn-enter:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(212,175,55,0.35);}
.pw-err{text-align:center;font-size:13px;color:var(--red);margin-top:12px;display:none;}
.pw-att{text-align:center;font-size:11px;color:var(--text-muted);margin-top:8px;display:none;}
@keyframes shake{0%,100%{transform:translateX(0);}20%,60%{transform:translateX(-7px);}40%,80%{transform:translateX(7px);}}

/* â•â• LOCKOUT â•â• */
#lockoutView{min-height:100vh;align-items:center;justify-content:center;flex-direction:column;padding:24px;text-align:center;gap:16px;}
.lo-icon{font-size:72px;}.lo-title{font-family:'Cormorant Garamond',serif;font-size:30px;color:var(--red);}
.lo-msg{font-size:14px;color:var(--text-muted);max-width:300px;line-height:1.6;}
.lo-timer{font-size:40px;font-weight:700;color:var(--gold);font-family:'Cormorant Garamond',serif;}

/* â•â• APP â•â• */
#appView{flex-direction:column;min-height:100vh;}
.app-header{position:sticky;top:0;z-index:100;background:rgba(6,14,8,0.93);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:0 20px;height:62px;display:flex;align-items:center;justify-content:space-between;}
.header-brand{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;color:var(--gold);letter-spacing:1px;}
.header-right{display:flex;align-items:center;gap:8px;}
.user-chip{display:flex;align-items:center;gap:7px;background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:6px 14px 6px 10px;font-size:13px;}
.u-dot{width:7px;height:7px;border-radius:50%;background:var(--emerald);box-shadow:0 0 6px var(--emerald);}
.cloud-chip{display:flex;align-items:center;gap:5px;background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:5px 12px;font-size:11px;color:var(--text-muted);}
.icon-btn{background:var(--surface);border:1px solid var(--border);border-radius:10px;width:38px;height:38px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;color:var(--text);transition:all 0.2s;}
.icon-btn:hover{border-color:var(--border2);color:var(--gold);}
.app-tabs{display:flex;background:var(--bg2);border-bottom:1px solid var(--border);padding:0 20px;overflow-x:auto;-webkit-overflow-scrolling:touch;}
.app-tabs::-webkit-scrollbar{display:none;}
.tab-btn{background:none;border:none;color:var(--text-muted);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:500;padding:13px 15px;cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s;white-space:nowrap;display:flex;align-items:center;gap:5px;}
.tab-btn.active{color:var(--gold);border-bottom-color:var(--gold);}
.tab-btn:hover:not(.active){color:var(--text);}
.app-content{flex:1;padding:24px;max-width:1100px;margin:0 auto;width:100%;}
.sec-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px;}
.sec-title{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:700;color:var(--gold-lt);}
.sec-title small{display:block;font-family:'Plus Jakarta Sans',sans-serif;font-size:11px;font-weight:400;color:var(--text-muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:2px;}
.back-btn{display:inline-flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:9px 16px;color:var(--text-muted);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;cursor:pointer;transition:all 0.2s;margin-bottom:20px;}
.back-btn:hover{border-color:var(--border2);color:var(--gold);}

/* UPLOAD */
.upload-zone{border:1.5px dashed rgba(212,175,55,0.25);border-radius:var(--radius);padding:36px;text-align:center;cursor:pointer;transition:all 0.3s;margin-bottom:26px;background:rgba(212,175,55,0.02);position:relative;}
.upload-zone:hover,.upload-zone.drag-over{border-color:var(--gold);background:rgba(212,175,55,0.05);}
.upload-zone input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.upload-icon{font-size:36px;margin-bottom:10px;color:var(--gold);}
.upload-zone h3{font-size:15px;font-weight:600;margin-bottom:4px;}
.upload-zone p{color:var(--text-muted);font-size:12px;}

/* PROGRESS */
.upload-progress-wrap{position:fixed;bottom:70px;right:24px;background:var(--surface);border:1px solid var(--border2);border-radius:14px;padding:16px 18px;z-index:998;min-width:240px;box-shadow:var(--shadow);display:none;}
.up-title{font-size:12px;color:var(--text-muted);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
.up-bar-bg{background:var(--bg);border-radius:4px;height:6px;overflow:hidden;margin-bottom:6px;}
.up-bar{height:100%;background:linear-gradient(90deg,var(--emerald-dk),var(--gold));border-radius:4px;width:0%;transition:width 0.3s;}
.up-txt{font-size:11px;color:var(--text-muted);}
.up-item{font-size:11px;color:var(--text-muted);margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* ALBUMS */
.albums-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:16px;}
.album-card{background:linear-gradient(145deg,var(--surface),var(--surface2));border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;cursor:pointer;transition:all 0.3s;}
.album-card:hover{transform:translateY(-5px);box-shadow:0 16px 40px rgba(0,0,0,0.5),0 0 20px rgba(212,175,55,0.07);border-color:var(--border2);}
.album-thumb{height:148px;display:flex;align-items:center;justify-content:center;font-size:50px;position:relative;overflow:hidden;background:var(--surface3);}
.album-thumb img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;}
.album-grd{position:absolute;bottom:0;left:0;right:0;height:50%;background:linear-gradient(transparent,rgba(0,0,0,0.6));}
.album-info{padding:14px;}
.album-name{font-weight:600;font-size:14px;margin-bottom:4px;}
.album-meta{font-size:11px;color:var(--text-muted);display:flex;justify-content:space-between;}

/* PHOTOS */
.photos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;}
.photo-item{aspect-ratio:1;background:var(--surface2);border-radius:12px;overflow:hidden;cursor:pointer;transition:all 0.2s;position:relative;border:1px solid var(--border);}
.photo-item:hover{transform:scale(1.04);box-shadow:0 8px 24px rgba(0,0,0,0.5);border-color:var(--border2);}
.photo-item img{width:100%;height:100%;object-fit:cover;display:block;}
.photo-item.loading{display:flex;align-items:center;justify-content:center;font-size:24px;}
.photo-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;gap:10px;opacity:0;transition:opacity 0.2s;}
.photo-item:hover .photo-overlay{opacity:1;}
.ph-act{background:rgba(255,255,255,0.1);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.2);border-radius:8px;width:38px;height:38px;color:white;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;}
.ph-act:hover{background:rgba(255,255,255,0.25);}
.ph-label{position:absolute;bottom:6px;left:6px;font-size:10px;background:rgba(0,0,0,0.75);padding:2px 7px;border-radius:4px;opacity:0;transition:opacity 0.2s;}
.photo-item:hover .ph-label{opacity:1;}

/* LIGHTBOX */
.lightbox{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.97);display:none;align-items:center;justify-content:center;animation:fadeIn 0.2s;}
.lightbox.open{display:flex;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.lb-img{max-width:90vw;max-height:85vh;border-radius:10px;object-fit:contain;box-shadow:0 0 80px rgba(0,0,0,0.9);}
.lb-close{position:fixed;top:18px;right:18px;background:rgba(255,255,255,0.08);border:none;border-radius:50%;width:44px;height:44px;color:white;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.lb-close:hover{background:rgba(255,255,255,0.18);}
.lb-nav{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);display:flex;gap:10px;}
.lb-btn{background:rgba(255,255,255,0.08);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.15);border-radius:12px;padding:10px 18px;color:white;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:500;display:flex;align-items:center;gap:6px;transition:all 0.2s;}
.lb-btn:hover{background:rgba(255,255,255,0.16);}
.lb-dl{background:linear-gradient(135deg,var(--gold-dk),var(--gold));border-color:transparent;color:#060e08;font-weight:700;}
.lb-dl:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(212,175,55,0.4);}

/* MEMORIES */
.memory-timeline{display:flex;flex-direction:column;gap:16px;}
.memory-card{background:linear-gradient(145deg,var(--surface),var(--surface2));border:1px solid var(--border);border-radius:var(--radius);padding:20px;display:flex;gap:16px;transition:border-color 0.2s;}
.memory-card:hover{border-color:var(--border2);}
.mem-date{flex-shrink:0;text-align:center;width:50px;}
.mem-day{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:700;color:var(--gold);line-height:1;}
.mem-month{font-size:10px;text-transform:uppercase;color:var(--text-muted);letter-spacing:1px;}
.mem-body{flex:1;}
.mem-title{font-size:15px;font-weight:600;margin-bottom:4px;}
.mem-desc{font-size:13px;color:var(--text-muted);line-height:1.6;}

/* MEMBERS */
.members-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;}
.member-card{background:linear-gradient(145deg,var(--surface),var(--surface2));border:1px solid var(--border);border-radius:var(--radius);padding:28px 20px;text-align:center;transition:all 0.3s;}
.member-card:hover{border-color:var(--border2);transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.4);}
.mc-av{font-size:48px;margin-bottom:12px;display:block;}
.mc-name{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:600;color:var(--gold-lt);}
.mc-urdu{font-size:16px;color:rgba(212,175,55,0.45);margin:2px 0;}
.mc-role{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;}
.mc-cnt{margin-top:10px;font-size:12px;color:var(--emerald);}

/* SETTINGS */
.settings-card{background:linear-gradient(145deg,var(--surface),var(--surface2));border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-bottom:14px;}
.settings-card h3{font-size:15px;font-weight:600;margin-bottom:14px;color:var(--gold-lt);}
.cloud-status{display:flex;align-items:center;gap:10px;padding:12px 14px;background:rgba(46,204,113,0.06);border:1px solid rgba(46,204,113,0.2);border-radius:10px;font-size:13px;margin-bottom:14px;}
.cloud-status.error{background:rgba(224,85,85,0.06);border-color:rgba(224,85,85,0.2);}
.cs-dot{width:8px;height:8px;border-radius:50%;background:var(--emerald);box-shadow:0 0 6px var(--emerald);flex-shrink:0;}
.cs-dot.error{background:var(--red);box-shadow:0 0 6px var(--red);}

/* COMMON */
.modal-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;padding:24px;}
.modal-overlay.open{display:flex;}
.modal-box{background:linear-gradient(145deg,var(--surface),var(--surface2));border:1px solid var(--border);border-radius:20px;padding:32px;width:100%;max-width:420px;box-shadow:var(--shadow);animation:slideUp 0.3s cubic-bezier(0.16,1,0.3,1);}
.modal-title{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;color:var(--gold);margin-bottom:22px;}
.inp-grp{margin-bottom:15px;}
.inp-grp label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);display:block;margin-bottom:7px;}
.inp-grp input,.inp-grp select{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:13px 15px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;outline:none;transition:border-color 0.2s,box-shadow 0.2s;}
.inp-grp input:focus,.inp-grp select:focus{border-color:var(--border2);box-shadow:0 0 0 3px rgba(212,175,55,0.08);}
.btn-gold{background:linear-gradient(135deg,var(--gold-dk),var(--gold));border:none;border-radius:10px;padding:12px 20px;color:#060e08;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s;}
.btn-gold:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(212,175,55,0.35);}
.btn-gold:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
.btn-ghost{background:transparent;border:1px solid var(--border);border-radius:10px;padding:12px 20px;color:var(--text-muted);font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;cursor:pointer;transition:all 0.2s;}
.btn-ghost:hover{border-color:var(--border2);color:var(--text);}
.btn-blue{background:linear-gradient(135deg,#1a7a8a,var(--blue));border:none;border-radius:10px;padding:12px 20px;color:#060e08;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s;}
.btn-blue:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(72,202,228,0.3);}
.badge-green{display:inline-flex;align-items:center;gap:4px;background:rgba(46,204,113,0.12);border:1px solid rgba(46,204,113,0.3);color:var(--emerald);padding:4px 10px;border-radius:20px;font-size:11px;font-weight:500;}
.badge-gold{display:inline-flex;align-items:center;gap:4px;background:rgba(212,175,55,0.1);border:1px solid var(--border2);color:var(--gold);padding:4px 10px;border-radius:20px;font-size:11px;font-weight:500;}
.tab-panel{display:none;}.tab-panel.active{display:block;}
.empty-state{text-align:center;padding:50px 20px;color:var(--text-muted);grid-column:1/-1;}
.empty-state .es-icon{font-size:48px;margin-bottom:14px;}
.empty-state h3{font-size:17px;color:var(--text);margin-bottom:6px;}
.empty-state p{font-size:13px;line-height:1.6;}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--surface);border:1px solid var(--border2);border-radius:12px;padding:14px 22px;font-size:13px;z-index:9999;box-shadow:var(--shadow);opacity:0;transition:all 0.35s cubic-bezier(0.16,1,0.3,1);white-space:nowrap;max-width:90vw;}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
.toast.error{border-color:rgba(224,85,85,0.5);color:var(--red);}
.offline-badge{position:fixed;top:14px;right:14px;background:linear-gradient(135deg,#c0392b,#e74c3c);color:white;padding:6px 14px;border-radius:20px;font-size:11px;font-weight:700;display:none;z-index:999;}
::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-track{background:var(--bg);}::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:3px;}
@media(max-width:480px){.members-grid-sel{grid-template-columns:repeat(2,1fr);}.albums-grid{grid-template-columns:repeat(2,1fr);}.photos-grid{grid-template-columns:repeat(2,1fr);}.app-content{padding:16px;}.brand-title{font-size:32px;}.pw-card{padding:32px 20px;}.cloud-chip{display:none;}}
</style>
</head>
<body>
<div class="offline-badge" id="offlineBadge">ğŸ“¡ Offline</div>
<div class="toast" id="toast"></div>

<!-- Upload Progress -->
<div class="upload-progress-wrap" id="uploadProgressWrap">
  <div class="up-title"><span>ğŸ“¤ Upload ho raha hai...</span><span id="upPct">0%</span></div>
  <div class="up-bar-bg"><div class="up-bar" id="upBar"></div></div>
  <div class="up-txt" id="upTxt">0 / 0 photos</div>
  <div class="up-item" id="upItem">â€”</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SETUP WIZARD â€” First time only
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view" id="setupView">
  <div class="setup-card">

    <!-- Step 1: Welcome -->
    <div class="setup-step active" id="setupStep1">
      <div class="step-badge">âœ¦ Pehli Baar Setup</div>
      <div class="setup-title">ğŸ¡ Hamara Ghar Setup</div>
      <div class="setup-desc">Aapki family ke liye ek private photo cloud! Shuru karne ke liye sirf ek baar <strong style="color:var(--gold)">Cloudinary</strong> ka free account banana hoga.</div>
      <div class="info-box">
        <strong>â˜ï¸ Cloudinary Free Plan milega:</strong><br>
        âœ… <strong>25 GB</strong> storage â€” ~12,000 photos<br>
        âœ… Kisi bhi phone par photos dikhenge<br>
        âœ… No credit card needed<br>
        âœ… Lifetime free
      </div>
      <button class="btn-gold" style="width:100%;" onclick="goSetupStep(2)">Shuru Karein â†’</button>
    </div>

    <!-- Step 2: Create Cloudinary Account -->
    <div class="setup-step" id="setupStep2">
      <div class="step-badge">ğŸ“‹ Step 1 of 3</div>
      <div class="setup-title">Cloudinary Account Banayein</div>
      <div class="setup-desc">Neeche ke steps follow karein â€” bilkul free hai:</div>
      <div class="step-num"><div class="sn">1</div><span><a href="https://cloudinary.com/users/register_free" target="_blank">cloudinary.com/users/register_free</a> par jaayein</span></div>
      <div class="step-num" style="margin-top:10px;"><div class="sn">2</div><span>Email, Password dalkar Sign Up karein</span></div>
      <div class="step-num" style="margin-top:10px;"><div class="sn">3</div><span>Email verify karein</span></div>
      <div class="step-num" style="margin-top:10px;"><div class="sn">4</div><span>Login karne ke baad <strong style="color:var(--gold)">Dashboard</strong> par jaayein</span></div>
      <div class="warn-box" style="margin-top:16px;">
        <strong>âš ï¸ Zaroori:</strong> Account banaate waqt <strong>Product Environment Name</strong> mein <code style="color:var(--gold)">hamara-ghar</code> type karein (ya koi bhi naam rakhein â€” yaad rahe)
      </div>
      <div style="display:flex;gap:10px;margin-top:8px;">
        <button class="btn-ghost" onclick="goSetupStep(1)">â† Wapas</button>
        <button class="btn-gold" style="flex:1;" onclick="goSetupStep(3)">Account Ban Gaya â†’</button>
      </div>
    </div>

    <!-- Step 3: Get Credentials -->
    <div class="setup-step" id="setupStep3">
      <div class="step-badge">ğŸ”‘ Step 2 of 3</div>
      <div class="setup-title">API Keys Lein</div>
      <div class="setup-desc">Cloudinary Dashboard par yeh 3 cheezein dhundhen:</div>
      <div class="info-box">
        Dashboard â†’ <strong>Settings â†’ API Keys</strong> mein jaayein<br><br>
        Wahan milega:<br>
        â€¢ <strong style="color:var(--gold)">Cloud Name</strong> (jaise: <code>dxyz123abc</code>)<br>
        â€¢ <strong style="color:var(--gold)">API Key</strong> (jaise: <code>123456789012345</code>)<br>
        â€¢ <strong style="color:var(--gold)">API Secret</strong> â€” <em style="color:var(--red)">âŒ Yeh NAHI chahiye</em>
      </div>
      <div class="warn-box">
        <strong>ğŸ“¤ Upload Preset bhi banana hoga:</strong><br>
        Settings â†’ <strong>Upload â†’ Upload Presets â†’ Add upload preset</strong><br>
        â€¢ Signing Mode: <strong style="color:var(--gold)">Unsigned</strong> select karein<br>
        â€¢ Preset name note kar lein (jaise: <code>hamaraghar_preset</code>)
      </div>
      <div style="display:flex;gap:10px;margin-top:8px;">
        <button class="btn-ghost" onclick="goSetupStep(2)">â† Wapas</button>
        <button class="btn-gold" style="flex:1;" onclick="goSetupStep(4)">Keys Mil Gayi â†’</button>
      </div>
    </div>

    <!-- Step 4: Enter Credentials -->
    <div class="setup-step" id="setupStep4">
      <div class="step-badge">âŒ¨ï¸ Step 3 of 3</div>
      <div class="setup-title">Details Enter Karein</div>
      <div class="inp-grp">
        <label>â˜ï¸ Cloud Name</label>
        <input type="text" id="cfCloudName" placeholder="jaise: dxyz123abc">
      </div>
      <div class="inp-grp">
        <label>ğŸ”‘ API Key</label>
        <input type="text" id="cfApiKey" placeholder="jaise: 123456789012345">
      </div>
      <div class="inp-grp">
        <label>ğŸ“¤ Upload Preset Name</label>
        <input type="text" id="cfPreset" placeholder="jaise: hamaraghar_preset">
      </div>
      <div class="inp-grp">
        <label>ğŸ” Family Password (banayein)</label>
        <input type="password" id="cfPassword" placeholder="min 6 characters...">
      </div>
      <p id="setupErr" style="color:var(--red);font-size:12px;margin-bottom:10px;display:none;"></p>
      <div style="display:flex;gap:10px;">
        <button class="btn-ghost" onclick="goSetupStep(3)">â† Wapas</button>
        <button class="btn-gold" style="flex:1;" id="setupSaveBtn" onclick="saveSetup()">âœ¦ Setup Complete Karein</button>
      </div>
    </div>

  </div>
</div>

<!-- â•â• MEMBER SELECT â•â• -->
<div class="view" id="memberView">
  <div style="width:100%;display:flex;flex-direction:column;align-items:center;padding:40px 24px 60px;">
    <div class="welcome-header">
      <div class="brand-emblem">ğŸ¡</div>
      <div class="brand-title">Hamara Ghar</div>
      <div class="brand-urdu">ÛÙ…Ø§Ø±Ø§ Ú¯Ú¾Ø±</div>
      <div class="brand-sub">Private Family Cloud</div>
      <div class="divider"><span>âœ¦</span></div>
    </div>
    <div class="member-prompt">Apna naam chunein â€” Ø§Ù¾Ù†Ø§ Ù†Ø§Ù… Ú†Ù†ÛŒÚº</div>
    <div class="members-grid-sel">
      <div class="msc" onclick="selectMember('kausar')">
        <div class="msc-av" style="background:linear-gradient(135deg,#1a3a2a,#0f2214);">ğŸŒ¸</div>
        <div class="msc-name">Kausar</div><div class="msc-urdu">Ú©ÙˆØ«Ø±</div>
        <div class="msc-role">Family Member</div>
      </div>
      <div class="msc" onclick="selectMember('naziya')">
        <div class="msc-av" style="background:linear-gradient(135deg,#2a1a3a,#1a0f2e);">ğŸŒ¹</div>
        <div class="msc-name">Naziya</div><div class="msc-urdu">Ù†Ø§Ø²ÛŒÛ</div>
        <div class="msc-role">Family Member</div>
      </div>
      <div class="msc" onclick="selectMember('nilofar')">
        <div class="msc-av" style="background:linear-gradient(135deg,#1a2a3a,#0f1a2e);">ğŸŒº</div>
        <div class="msc-name">Nilofar</div><div class="msc-urdu">Ù†ÛŒÙ„ÙˆÙØ±</div>
        <div class="msc-role">Family Member</div>
      </div>
      <div class="msc" onclick="selectMember('vaseem')">
        <div class="msc-av" style="background:linear-gradient(135deg,#2a2a1a,#1a1a0f);">ğŸŒ¿</div>
        <div class="msc-name">Vaseem</div><div class="msc-urdu">ÙˆØ³ÛŒÙ…</div>
        <div class="msc-role">Family Member</div>
      </div>
    </div>
    <div class="bismillah">âœ¦ ï·½ âœ¦ â€” Sirf Hamare Ghar Ke Liye</div>
  </div>
</div>

<!-- â•â• PASSWORD â•â• -->
<div class="view" id="passwordView">
  <div style="width:100%;display:flex;align-items:center;justify-content:center;padding:24px;min-height:100vh;">
    <div class="pw-card" id="pwCard">
      <button class="pw-back" onclick="goBackToMembers()">â† Wapas Jao</button>
      <div class="pw-user">
        <div class="pw-avatar"><span id="pwEmoji">ğŸŒ¸</span></div>
        <div class="pw-name" id="pwName">Kausar</div>
        <div class="pw-greet">Assalamu Alaikum ğŸ¤² Password enter karein</div>
      </div>
      <div class="pw-dots">
        <div class="pw-dot" id="d0"></div><div class="pw-dot" id="d1"></div>
        <div class="pw-dot" id="d2"></div><div class="pw-dot" id="d3"></div>
        <div class="pw-dot" id="d4"></div><div class="pw-dot" id="d5"></div>
        <div class="pw-dot" id="d6"></div><div class="pw-dot" id="d7"></div>
      </div>
      <span class="pw-lbl">Family Password</span>
      <div class="pw-wrap">
        <input class="pw-inp" type="password" id="pwInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
          oninput="updateDots()" onkeydown="if(event.key==='Enter')doLogin()">
        <button class="pw-eye" onclick="togglePwVis()">ğŸ‘ï¸</button>
      </div>
      <button class="btn-enter" onclick="doLogin()">âœ¦ Ghar Mein Pravesh Karein</button>
      <p class="pw-err" id="pwErr">âŒ Galat password!</p>
      <p class="pw-att" id="pwAtt"></p>
    </div>
  </div>
</div>

<!-- â•â• LOCKOUT â•â• -->
<div class="view" id="lockoutView">
  <div class="lo-icon">ğŸ”’</div>
  <div class="lo-title">Temporarily Locked</div>
  <div class="lo-msg">5 baar galat password dala. 5 minute baad try karein.</div>
  <div class="lo-timer" id="loTimer">05:00</div>
  <button class="btn-ghost" onclick="tryUnlock()" style="margin-top:8px;">ğŸ”„ Check Again</button>
</div>

<!-- â•â• MAIN APP â•â• -->
<div class="view" id="appView">
  <header class="app-header">
    <div class="header-brand">ğŸ¡ Hamara Ghar</div>
    <div class="header-right">
      <div class="cloud-chip" id="cloudChip">â˜ï¸ <span id="cloudChipTxt">Connecting...</span></div>
      <div class="user-chip"><div class="u-dot"></div><span id="userChipTxt">â€”</span></div>
      <button class="icon-btn" onclick="doLogout()" title="Logout">ğŸšª</button>
    </div>
  </header>
  <nav class="app-tabs">
    <button class="tab-btn active" onclick="switchTab('albums',this)">ğŸ–¼ï¸ Albums</button>
    <button class="tab-btn" onclick="switchTab('photos',this)">ğŸ“· All Photos</button>
    <button class="tab-btn" onclick="switchTab('memories',this)">ğŸ’ Yaadein</button>
    <button class="tab-btn" onclick="switchTab('members',this)">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Family</button>
    <button class="tab-btn" onclick="switchTab('settings',this)">âš™ï¸ Settings</button>
  </nav>
  <div class="app-content">

    <!-- ALBUMS -->
    <div class="tab-panel active" id="tab-albums">
      <div id="albumListView">
        <div class="sec-hdr">
          <div class="sec-title"><small>Photo Albums</small>Hamari Gallery</div>
          <button class="btn-gold" onclick="openModal('addAlbumModal')">+ New Album</button>
        </div>
        <div class="upload-zone" id="mainUploadZone">
          <input type="file" multiple accept="image/*" id="mainFileInput" onchange="handleUpload(this.files,'main')">
          <div class="upload-icon">â˜ï¸</div>
          <h3>Photos Cloudinary Par Upload Karein</h3>
          <p>Click karein ya drop karein â€¢ JPG, PNG â€¢ Ek saath kai photos â€¢ 25 GB free storage</p>
        </div>
        <div class="albums-grid" id="albumsGrid"></div>
      </div>
      <div id="albumDetailView" style="display:none;">
        <button class="back-btn" onclick="showAlbumList()">â† Albums Par Wapas</button>
        <div class="sec-hdr">
          <div class="sec-title" id="albDetailTitle"><small>Album</small></div>
          <div style="display:flex;gap:8px;">
            <button class="btn-ghost" onclick="document.getElementById('albUploadInp').click()">+ Add Photos</button>
            <input type="file" id="albUploadInp" multiple accept="image/*" style="display:none" onchange="handleUpload(this.files,'album')">
            <button class="btn-gold" id="dlAlbumBtn">â¬‡ Download All</button>
          </div>
        </div>
        <div class="photos-grid" id="albumPhotosGrid"></div>
      </div>
    </div>

    <!-- ALL PHOTOS -->
    <div class="tab-panel" id="tab-photos">
      <div class="sec-hdr">
        <div class="sec-title"><small>All Photos</small>Saari Tasveeren</div>
        <div style="display:flex;gap:8px;">
          <button class="btn-ghost" onclick="toggleSort()">â‡… Sort</button>
          <button class="btn-gold" onclick="document.getElementById('allUploadInp').click()">+ Upload</button>
          <input type="file" id="allUploadInp" multiple accept="image/*" style="display:none" onchange="handleUpload(this.files,'all')">
        </div>
      </div>
      <div class="photos-grid" id="allPhotosGrid"></div>
    </div>

    <!-- MEMORIES -->
    <div class="tab-panel" id="tab-memories">
      <div class="sec-hdr">
        <div class="sec-title"><small>Yaadein</small>Khaas Lamhe</div>
        <button class="btn-gold" onclick="openAddMemory()">+ Add Memory</button>
      </div>
      <div class="memory-timeline" id="memoryTimeline"></div>
    </div>

    <!-- MEMBERS -->
    <div class="tab-panel" id="tab-members">
      <div class="sec-hdr">
        <div class="sec-title"><small>Hamara Parivaar</small>Family Members</div>
      </div>
      <div class="members-grid" id="membersGrid"></div>
    </div>

    <!-- SETTINGS -->
    <div class="tab-panel" id="tab-settings">
      <div class="sec-title" style="margin-bottom:20px;"><small>Settings</small>App Configure Karein</div>

      <div class="settings-card">
        <h3>â˜ï¸ Cloudinary Status</h3>
        <div class="cloud-status" id="cloudStatusBox">
          <div class="cs-dot"></div>
          <div><strong style="color:var(--emerald);">Connected âœ…</strong><br>
          <span style="font-size:11px;color:var(--text-muted);" id="cloudStatusDetail">Cloud Name: â€”</span></div>
        </div>
        <div style="font-size:12px;color:var(--text-muted);line-height:1.7;">
          ğŸ“¦ Storage: <strong style="color:var(--gold);">25 GB Free</strong> (~12,000 photos)<br>
          ğŸ“¸ Total Photos: <strong id="totalPhotosCount" style="color:var(--gold-lt);">Loading...</strong>
        </div>
      </div>

      <div class="settings-card">
        <h3>ğŸ”‘ Password Change</h3>
        <div class="inp-grp" style="max-width:300px;">
          <label>Naya Password</label>
          <input type="password" id="newPwInp" placeholder="Min 6 characters...">
        </div>
        <div class="inp-grp" style="max-width:300px;">
          <label>Confirm Password</label>
          <input type="password" id="confirmPwInp" placeholder="Dobara daalen...">
        </div>
        <button class="btn-gold" onclick="changePassword()">ğŸ’¾ Save</button>
      </div>

      <div class="settings-card">
        <h3>â˜ï¸ Cloudinary Config Update</h3>
        <div class="inp-grp" style="max-width:300px;">
          <label>Cloud Name</label>
          <input type="text" id="updCloudName" placeholder="Cloud name...">
        </div>
        <div class="inp-grp" style="max-width:300px;">
          <label>API Key</label>
          <input type="text" id="updApiKey" placeholder="API Key...">
        </div>
        <div class="inp-grp" style="max-width:300px;">
          <label>Upload Preset</label>
          <input type="text" id="updPreset" placeholder="Upload preset name...">
        </div>
        <button class="btn-blue" onclick="updateCloudConfig()">â˜ï¸ Update Config</button>
      </div>

      <div class="settings-card" style="border-color:rgba(224,85,85,0.25);">
        <h3 style="color:var(--red);">âš ï¸ Danger Zone</h3>
        <p style="font-size:13px;color:var(--text-muted);margin-bottom:14px;">Local data clear hoga (Cloudinary photos safe rahenge).</p>
        <button class="btn-ghost" style="border-color:rgba(224,85,85,0.4);color:var(--red);" onclick="clearLocalData()">ğŸ—‘ï¸ Local Data Clear</button>
      </div>
    </div>
  </div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox" onclick="lbBgClick(event)">
  <img class="lb-img" id="lbImg" src="" alt="">
  <button class="lb-close" onclick="closeLightbox()">âœ•</button>
  <div class="lb-nav">
    <button class="lb-btn" onclick="prevPhoto()">â† Pehli</button>
    <button class="lb-btn lb-dl" onclick="downloadCurrent()">â¬‡ Download</button>
    <button class="lb-btn" onclick="nextPhoto()">Agli â†’</button>
  </div>
</div>

<!-- ADD ALBUM MODAL -->
<div class="modal-overlay" id="addAlbumModal">
  <div class="modal-box">
    <div class="modal-title">ğŸ“ Naya Album Banayein</div>
    <div class="inp-grp"><label>Album Ka Naam</label>
      <input type="text" id="albNameInp" placeholder="Jaise: Eid 2024, Kashmir Trip..."></div>
    <div class="inp-grp"><label>Emoji</label>
      <input type="text" id="albEmojiInp" value="ğŸ“¸" placeholder="ğŸ“¸ ğŸ•Œ ğŸ‚ ğŸŒ¸"></div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn-gold" style="flex:1;" onclick="createAlbum()">âœ¦ Create</button>
      <button class="btn-ghost" onclick="closeModal('addAlbumModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- ADD MEMORY MODAL -->
<div class="modal-overlay" id="addMemoryModal">
  <div class="modal-box">
    <div class="modal-title">ğŸ’ Yaad Likhein</div>
    <div class="inp-grp"><label>Title</label>
      <input type="text" id="memTitleInp" placeholder="Khaas lamhe ka naam..."></div>
    <div class="inp-grp"><label>Tarikh</label>
      <input type="date" id="memDateInp"></div>
    <div class="inp-grp"><label>Description</label>
      <input type="text" id="memDescInp" placeholder="Is waqt ki yaad..."></div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn-gold" style="flex:1;" onclick="saveMemory()">ğŸ’¾ Save</button>
      <button class="btn-ghost" onclick="closeModal('addMemoryModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FAMILY MEMBERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FAMILY = {
  kausar:  {name:'Kausar', emoji:'ğŸŒ¸', role:'Ghar Ki Roshni',  urdu:'Ú©ÙˆØ«Ø±'},
  naziya:  {name:'Naziya', emoji:'ğŸŒ¹', role:'Pyaar Ki Pratik', urdu:'Ù†Ø§Ø²ÛŒÛ'},
  nilofar: {name:'Nilofar',emoji:'ğŸŒº', role:'Phoolon Ki Rani', urdu:'Ù†ÛŒÙ„ÙˆÙØ±'},
  vaseem:  {name:'Vaseem', emoji:'ğŸŒ¿', role:'Ghar Ka Sitaara', urdu:'ÙˆØ³ÛŒÙ…'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STORAGE KEYS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const K = {
  config:    'hg_config',      // {cloudName, apiKey, preset, pw}
  data:      'hg_data',        // {albums, photos(metadata), memories}
  session:   'hg_sess',
  attempts:  'hg_att',
  lock:      'hg_lock',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser = null, selectedMember = null;
let currentPhotos = [], currentPhotoIdx = 0;
let currentAlbum = null, sortDesc = true;
let lockTimer = null;
let cloudConfig = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getConfig() {
  try { return JSON.parse(localStorage.getItem(K.config)); } catch { return null; }
}
function setConfig(c) { localStorage.setItem(K.config, JSON.stringify(c)); }
function isConfigured() {
  const c = getConfig();
  return c && c.cloudName && c.apiKey && c.preset && c.pw;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA (albums + photo metadata + memories)
//  Photos are stored in Cloudinary.
//  Only metadata (url, publicId, albumId etc) stored locally.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadData() {
  try { return JSON.parse(localStorage.getItem(K.data)) || defaultData(); }
  catch { return defaultData(); }
}
function saveData(d) {
  try { localStorage.setItem(K.data, JSON.stringify(d)); }
  catch(e) { showToast('âš ï¸ Local storage error!', true); }
}
function defaultData() {
  return {
    albums:[
      {id:'a1', name:'Eid Ki Khushiyan', emoji:'ğŸ•Œ', photoIds:[], createdBy:'Family', createdAt:Date.now()-864e5*5},
      {id:'a2', name:'Ghar Ki Yaadein',  emoji:'ğŸ¡', photoIds:[], createdBy:'Family', createdAt:Date.now()-864e5*10},
    ],
    photos:[],   // [{id, publicId, url, thumbUrl, name, uploadedBy, uploadedAt, albumId}]
    memories:[
      {id:'m1', title:'ğŸ•Œ Eid Mubarak!', date:'2024-04-10', desc:'Is saal ki Eid bahut achi rahi. Poora ghar saath tha.'},
      {id:'m2', title:'ğŸŒ¸ Pehli Barish',  date:'2024-07-15', desc:'Baarish mein saath chai piya â€” bahut pyaara lamha tha.'},
    ]
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLOUDINARY â€” UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function uploadToCloudinary(file, folder) {
  const cfg = getConfig();
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', cfg.preset);
  formData.append('folder', `hamara-ghar/${folder}`);
  formData.append('tags', `hamara-ghar,${folder}`);

  const res = await fetch(
    `https://api.cloudinary.com/v1_1/${cfg.cloudName}/image/upload`,
    { method: 'POST', body: formData }
  );

  if (!res.ok) {
    const err = await res.json().catch(()=>({}));
    throw new Error(err.error?.message || 'Upload failed ('+res.status+')');
  }
  return await res.json();
  // returns {public_id, secure_url, width, height, ...}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HANDLE UPLOAD  (multiple files)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function handleUpload(files, context) {
  if (!files || !files.length) return;
  const cfg = getConfig();
  if (!cfg) { showToast('âŒ Cloudinary config nahi hai!', true); return; }

  const fileArr = Array.from(files);
  const folder = currentAlbum || 'general';
  const data = loadData();
  let done = 0;
  const total = fileArr.length;

  // Show progress
  const pw = document.getElementById('uploadProgressWrap');
  pw.style.display = 'block';
  updateProgress(0, total, '');

  for (const file of fileArr) {
    try {
      document.getElementById('upItem').textContent = 'ğŸ“¸ ' + file.name;
      const result = await uploadToCloudinary(file, folder);

      // Cloudinary thumb URL (auto-resize to 400px)
      const thumbUrl = result.secure_url.replace('/upload/', '/upload/w_400,h_400,c_fill,q_auto,f_auto/');

      const photo = {
        id: 'p-' + Date.now() + '-' + Math.random().toString(36).slice(2,6),
        publicId: result.public_id,
        url: result.secure_url,
        thumbUrl: thumbUrl,
        name: file.name,
        width: result.width,
        height: result.height,
        uploadedBy: FAMILY[currentUser]?.name || currentUser,
        uploadedAt: Date.now(),
        albumId: currentAlbum || null,
      };

      data.photos.unshift(photo);
      if (currentAlbum) {
        const alb = data.albums.find(a => a.id === currentAlbum);
        if (alb && !alb.photoIds.includes(photo.id)) alb.photoIds.unshift(photo.id);
      }

      done++;
      updateProgress(done, total, file.name);
      saveData(data);

      // Re-render incrementally
      if (currentAlbum) renderAlbumPhotos(data);
      else renderAllPhotosGrid(data);
      renderAlbums();

    } catch(err) {
      done++;
      updateProgress(done, total, file.name);
      showToast('âŒ "'+file.name+'" upload nahi hua: '+err.message, true);
    }
  }

  setTimeout(() => { pw.style.display = 'none'; }, 2000);
  showToast('âœ… ' + done + '/' + total + ' photos Cloudinary par upload ho gaye! â˜ï¸');
  updatePhotoCount(data);
}

function updateProgress(done, total, filename) {
  const pct = total > 0 ? Math.round(done/total*100) : 0;
  document.getElementById('upBar').style.width = pct+'%';
  document.getElementById('upPct').textContent = pct+'%';
  document.getElementById('upTxt').textContent = done+' / '+total+' photos';
  if (filename) document.getElementById('upItem').textContent = done >= total ? 'âœ… Done!' : 'ğŸ“¸ '+filename;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER â€” ALBUMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAlbums() {
  const data = loadData();
  const grid = document.getElementById('albumsGrid');
  if (!data.albums.length) {
    grid.innerHTML = '<div class="empty-state"><div class="es-icon">ğŸ“‚</div><h3>Koi album nahi</h3><p>New album banayein ya photos upload karein</p></div>';
    return;
  }
  grid.innerHTML = data.albums.map(alb => {
    const photos = data.photos.filter(p => alb.photoIds.includes(p.id));
    const thumb = photos[0]?.thumbUrl || null;
    return `<div class="album-card" onclick="openAlbum('${alb.id}')">
      <div class="album-thumb">
        ${thumb ? `<img src="${thumb}" alt="${alb.name}" loading="lazy">` : alb.emoji}
        <div class="album-grd"></div>
      </div>
      <div class="album-info">
        <div class="album-name">${alb.emoji} ${alb.name}</div>
        <div class="album-meta"><span>${photos.length} photos</span><span>${alb.createdBy}</span></div>
      </div>
    </div>`;
  }).join('');
}

function openAlbum(id) {
  currentAlbum = id;
  const data = loadData();
  const alb = data.albums.find(a => a.id === id);
  document.getElementById('albumListView').style.display = 'none';
  document.getElementById('albumDetailView').style.display = 'block';
  document.getElementById('albDetailTitle').innerHTML = `<small>Album</small>${alb.emoji} ${alb.name}`;
  document.getElementById('dlAlbumBtn').onclick = () => downloadAlbum(id);
  renderAlbumPhotos(data);
}

function renderAlbumPhotos(data) {
  if (!currentAlbum) return;
  const alb = data.albums.find(a => a.id === currentAlbum);
  const photos = data.photos.filter(p => alb.photoIds.includes(p.id));
  currentPhotos = photos;
  const grid = document.getElementById('albumPhotosGrid');
  if (!photos.length) {
    grid.innerHTML = '<div class="empty-state"><div class="es-icon">ğŸ“·</div><h3>Album khali hai</h3><p>"Add Photos" button se upload karein</p></div>';
    return;
  }
  grid.innerHTML = photos.map((p,i) => photoCard(p,i)).join('');
}

function showAlbumList() {
  currentAlbum = null;
  document.getElementById('albumListView').style.display = 'block';
  document.getElementById('albumDetailView').style.display = 'none';
  renderAlbums();
}

function createAlbum() {
  const name = document.getElementById('albNameInp').value.trim();
  const emoji = document.getElementById('albEmojiInp').value.trim() || 'ğŸ“¸';
  if (!name) { showToast('âš ï¸ Album ka naam daalo!'); return; }
  const data = loadData();
  data.albums.unshift({id:'a-'+Date.now(), name, emoji, photoIds:[], createdBy:FAMILY[currentUser]?.name||currentUser, createdAt:Date.now()});
  saveData(data); closeModal('addAlbumModal');
  document.getElementById('albNameInp').value = '';
  renderAlbums(); showToast('ğŸ“ "'+name+'" album ban gaya!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER â€” ALL PHOTOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAllPhotosGrid(data) {
  data = data || loadData();
  const grid = document.getElementById('allPhotosGrid');
  let photos = [...data.photos];
  photos.sort((a,b) => sortDesc ? b.uploadedAt-a.uploadedAt : a.uploadedAt-b.uploadedAt);
  if (!photos.length) {
    grid.innerHTML = '<div class="empty-state"><div class="es-icon">ğŸ–¼ï¸</div><h3>Koi photo nahi</h3><p>Upload karna shuru karein!</p></div>';
    return;
  }
  currentPhotos = photos;
  grid.innerHTML = photos.map((p,i) => photoCard(p,i)).join('');
}

function toggleSort() {
  sortDesc = !sortDesc;
  renderAllPhotosGrid();
  showToast(sortDesc ? 'ğŸ• Naye pehle' : 'ğŸ• Purane pehle');
}

function photoCard(p, i) {
  return `<div class="photo-item" onclick="openLightbox(${i})">
    <img src="${p.thumbUrl||p.url}" alt="${p.name}" loading="lazy">
    <div class="photo-overlay">
      <button class="ph-act" onclick="event.stopPropagation();downloadPhoto('${p.id}')">â¬‡</button>
      <button class="ph-act" onclick="event.stopPropagation();deletePhoto('${p.id}')">ğŸ—‘ï¸</button>
    </div>
    <div class="ph-label">${p.uploadedBy}</div>
  </div>`;
}

function updatePhotoCount(data) {
  data = data || loadData();
  const el = document.getElementById('totalPhotosCount');
  if (el) el.textContent = data.photos.length + ' photos';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LIGHTBOX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLightbox(i) {
  currentPhotoIdx = i;
  document.getElementById('lbImg').src = currentPhotos[i].url;
  document.getElementById('lightbox').classList.add('open');
}
function closeLightbox() { document.getElementById('lightbox').classList.remove('open'); }
function lbBgClick(e) { if(e.target.id==='lightbox') closeLightbox(); }
function prevPhoto() { currentPhotoIdx=(currentPhotoIdx-1+currentPhotos.length)%currentPhotos.length; document.getElementById('lbImg').src=currentPhotos[currentPhotoIdx].url; }
function nextPhoto() { currentPhotoIdx=(currentPhotoIdx+1)%currentPhotos.length; document.getElementById('lbImg').src=currentPhotos[currentPhotoIdx].url; }
function downloadCurrent() { downloadPhoto(currentPhotos[currentPhotoIdx].id); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOWNLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function downloadPhoto(id) {
  const p = loadData().photos.find(ph=>ph.id===id);
  if (!p) return;
  // Force download via anchor
  const a = document.createElement('a');
  // Use Cloudinary fl_attachment transformation for direct download
  const cfg = getConfig();
  const dlUrl = p.url.replace('/upload/', '/upload/fl_attachment/');
  a.href = dlUrl; a.download = p.name; a.target='_blank'; a.click();
  showToast('â¬‡ Download shuru hua...');
}

function downloadAlbum(id) {
  const data = loadData();
  const alb = data.albums.find(a=>a.id===id);
  const photos = data.photos.filter(p=>alb.photoIds.includes(p.id));
  if (!photos.length) { showToast('âŒ Album mein koi photo nahi!', true); return; }
  photos.forEach((p,i) => setTimeout(()=>{
    const a=document.createElement('a');
    a.href=p.url.replace('/upload/','/upload/fl_attachment/');
    a.download=p.name; a.target='_blank'; a.click();
  }, i*400));
  showToast('â¬‡ '+photos.length+' photos download ho rahe hain...');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DELETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function deletePhoto(id) {
  if (!confirm('Yeh tasveer sirf is device se hategi (Cloudinary se nahi). Confirm?')) return;
  const data = loadData();
  data.photos = data.photos.filter(p=>p.id!==id);
  data.albums.forEach(a=>{a.photoIds=a.photoIds.filter(pid=>pid!==id);});
  saveData(data);
  if (currentAlbum) renderAlbumPhotos(data); else renderAllPhotosGrid(data);
  renderAlbums();
  showToast('ğŸ—‘ï¸ Photo remove ho gayi.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MEMBERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMembers() {
  const data = loadData();
  document.getElementById('membersGrid').innerHTML = Object.entries(FAMILY).map(([k,m])=>{
    const cnt = data.photos.filter(p=>p.uploadedBy===m.name).length;
    return `<div class="member-card">
      <span class="mc-av">${m.emoji}</span>
      <div class="mc-name">${m.name}</div>
      <div class="mc-urdu">${m.urdu}</div>
      <div class="mc-role">${m.role}</div>
      <div class="mc-cnt">â˜ï¸ ${cnt} photos uploaded</div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MEMORIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMemories() {
  const data = loadData();
  const tl = document.getElementById('memoryTimeline');
  if (!data.memories.length) {
    tl.innerHTML = '<div class="empty-state"><div class="es-icon">ğŸ’</div><h3>Koi yaad nahi</h3><p>Khaas lamhe yahan save karein</p></div>'; return;
  }
  tl.innerHTML = data.memories.map(m=>{
    const d=new Date(m.date);
    return `<div class="memory-card">
      <div class="mem-date"><div class="mem-day">${d.getDate()}</div><div class="mem-month">${d.toLocaleString('default',{month:'short'})}</div></div>
      <div class="mem-body"><div class="mem-title">${m.title}</div><div class="mem-desc">${m.desc}</div></div>
    </div>`;
  }).join('');
}
function openAddMemory() { document.getElementById('memDateInp').valueAsDate=new Date(); openModal('addMemoryModal'); }
function saveMemory() {
  const title=document.getElementById('memTitleInp').value.trim();
  const date=document.getElementById('memDateInp').value;
  const desc=document.getElementById('memDescInp').value.trim();
  if(!title||!date){showToast('âš ï¸ Title aur date zaroori!',true);return;}
  const data=loadData();
  data.memories.unshift({id:'m-'+Date.now(),title,date,desc});
  saveData(data); closeModal('addMemoryModal');
  document.getElementById('memTitleInp').value=''; document.getElementById('memDescInp').value='';
  renderMemories(); showToast('ğŸ’ Yaad save ho gayi!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function changePassword() {
  const np=document.getElementById('newPwInp').value;
  const cp=document.getElementById('confirmPwInp').value;
  if(!np||np.length<6){showToast('âš ï¸ Password min 6 characters!',true);return;}
  if(np!==cp){showToast('âŒ Passwords match nahi karte!',true);return;}
  const cfg=getConfig(); cfg.pw=np; setConfig(cfg);
  document.getElementById('newPwInp').value=''; document.getElementById('confirmPwInp').value='';
  showToast('ğŸ”‘ Password change ho gaya!');
}
function updateCloudConfig() {
  const cn=document.getElementById('updCloudName').value.trim();
  const ak=document.getElementById('updApiKey').value.trim();
  const pr=document.getElementById('updPreset').value.trim();
  if(!cn||!ak||!pr){showToast('âš ï¸ Sab fields bharo!',true);return;}
  const cfg=getConfig(); cfg.cloudName=cn; cfg.apiKey=ak; cfg.preset=pr; setConfig(cfg);
  updateCloudStatus();
  showToast('â˜ï¸ Cloudinary config update ho gaya!');
}
function clearLocalData() {
  if(!confirm('Local data clear hoga. Cloudinary par photos safe rahenge. Pakka?')) return;
  const cfg=getConfig(); // keep config
  localStorage.removeItem(K.data);
  setConfig(cfg);
  renderAll();
  showToast('ğŸ—‘ï¸ Local data clear ho gaya. Photos Cloudinary par safe hain.');
}
function updateCloudStatus() {
  const cfg=getConfig();
  if(cfg&&cfg.cloudName){
    document.getElementById('cloudStatusDetail').textContent='Cloud: '+cfg.cloudName+' | Key: '+cfg.apiKey?.slice(0,6)+'...';
    document.getElementById('cloudChipTxt').textContent=cfg.cloudName;
    // Pre-fill update fields
    document.getElementById('updCloudName').value=cfg.cloudName;
    document.getElementById('updApiKey').value=cfg.apiKey;
    document.getElementById('updPreset').value=cfg.preset;
  }
  updatePhotoCount();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name,btn) {
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  if(name==='albums'){showAlbumList();}
  if(name==='photos')renderAllPhotosGrid();
  if(name==='memories')renderMemories();
  if(name==='members')renderMembers();
  if(name==='settings')updateCloudStatus();
}
function renderAll(){renderAlbums();renderMembers();renderMemories();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETUP WIZARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goSetupStep(n) {
  document.querySelectorAll('.setup-step').forEach(s=>s.classList.remove('active'));
  document.getElementById('setupStep'+n).classList.add('active');
}
function saveSetup() {
  const cn=document.getElementById('cfCloudName').value.trim();
  const ak=document.getElementById('cfApiKey').value.trim();
  const pr=document.getElementById('cfPreset').value.trim();
  const pw=document.getElementById('cfPassword').value;
  const errEl=document.getElementById('setupErr');

  if(!cn||!ak||!pr){errEl.textContent='âš ï¸ Cloud Name, API Key aur Preset zaroori hai!';errEl.style.display='block';return;}
  if(!pw||pw.length<6){errEl.textContent='âš ï¸ Password min 6 characters ka hona chahiye!';errEl.style.display='block';return;}
  errEl.style.display='none';

  const btn=document.getElementById('setupSaveBtn');
  btn.disabled=true; btn.textContent='Saving...';

  setConfig({cloudName:cn, apiKey:ak, preset:pr, pw:pw});
  showToast('âœ… Setup complete! Welcome to Hamara Ghar ğŸ¡');
  setTimeout(()=>showView('memberView'), 800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGIN SECURITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const getAtt=()=>{try{return parseInt(localStorage.getItem(K.attempts)||'0');}catch{return 0;}};
const setAtt=n=>{try{localStorage.setItem(K.attempts,String(n));}catch{}};
const getLock=()=>{try{return parseInt(localStorage.getItem(K.lock)||'0');}catch{return 0;}};
const setLock=t=>{try{localStorage.setItem(K.lock,String(t));}catch{}};

function isLocked(){
  const t=getLock(); if(!t)return false;
  if(Date.now()<t)return true;
  setLock(0);setAtt(0);return false;
}
function lockAccount(){setLock(Date.now()+5*60*1000);setAtt(0);showView('lockoutView');startLockTimer();}
function startLockTimer(){
  if(lockTimer)clearInterval(lockTimer);
  lockTimer=setInterval(()=>{
    const rem=Math.max(0,getLock()-Date.now());
    const m=Math.floor(rem/60000),s=Math.floor((rem%60000)/1000);
    document.getElementById('loTimer').textContent=String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
    if(rem<=0){clearInterval(lockTimer);setLock(0);setAtt(0);showView('memberView');}
  },500);
}
function tryUnlock(){if(!isLocked()){if(lockTimer)clearInterval(lockTimer);showView('memberView');}else{showToast('â³ Abhi lock hai.',true);startLockTimer();}}

function selectMember(id){
  if(isLocked()){startLockTimer();showView('lockoutView');return;}
  selectedMember=id;
  const m=FAMILY[id];
  document.getElementById('pwEmoji').textContent=m.emoji;
  document.getElementById('pwName').textContent=m.name;
  document.getElementById('pwInput').value='';
  document.getElementById('pwErr').style.display='none';
  document.getElementById('pwAtt').style.display='none';
  updateDots(); showView('passwordView');
  setTimeout(()=>document.getElementById('pwInput').focus(),300);
}
function goBackToMembers(){selectedMember=null;showView('memberView');}
function updateDots(){const len=document.getElementById('pwInput').value.length;for(let i=0;i<8;i++){const d=document.getElementById('d'+i);if(d)d.classList.toggle('filled',i<len);}}
function togglePwVis(){const i=document.getElementById('pwInput');i.type=i.type==='password'?'text':'password';}
function doLogin(){
  if(isLocked()){lockAccount();return;}
  const entered=document.getElementById('pwInput').value;
  const stored=(getConfig()||{}).pw;
  if(entered&&stored&&entered===stored&&selectedMember){
    setAtt(0); currentUser=selectedMember;
    try{sessionStorage.setItem(K.session,JSON.stringify({m:currentUser,t:Date.now()}));}catch{}
    enterApp();
  } else {
    const att=getAtt()+1; setAtt(att);
    const rem=5-att;
    document.getElementById('pwInput').value=''; updateDots();
    document.getElementById('pwErr').style.display='block';
    const card=document.getElementById('pwCard');
    card.style.animation='none';void card.offsetWidth;card.style.animation='shake 0.4s';
    if(rem<=0){lockAccount();return;}
    if(rem<=3){document.getElementById('pwAtt').style.display='block';document.getElementById('pwAtt').textContent='âš ï¸ '+rem+' baar aur galat hua to 5 min lock!';}
  }
}
function enterApp(){
  const m=FAMILY[currentUser];
  document.getElementById('userChipTxt').textContent=m.emoji+' '+m.name;
  showView('appView');
  updateCloudStatus();
  renderAll();
}
function doLogout(){
  try{sessionStorage.removeItem(K.session);}catch{}
  currentUser=null; selectedMember=null;
  showView('memberView'); showToast('ğŸ‘‹ Logout ho gaye. Khuda Hafiz!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showView(id){document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));document.getElementById(id).classList.add('active');}
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function showToast(msg,isErr=false){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className='toast show'+(isErr?' error':'');
  setTimeout(()=>t.className='toast',3500);
}

// Keyboard shortcuts
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){closeLightbox();document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.remove('open'));}
  if(document.getElementById('lightbox').classList.contains('open')){
    if(e.key==='ArrowLeft')prevPhoto();if(e.key==='ArrowRight')nextPhoto();
  }
  if(document.getElementById('passwordView').classList.contains('active')&&e.key==='Escape')goBackToMembers();
});

// Drag & drop on upload zone
const uz=document.getElementById('mainUploadZone');
uz.addEventListener('dragover',e=>{e.preventDefault();uz.classList.add('drag-over');});
uz.addEventListener('dragleave',()=>uz.classList.remove('drag-over'));
uz.addEventListener('drop',e=>{e.preventDefault();uz.classList.remove('drag-over');handleUpload(e.dataTransfer.files,'main');});

// Offline indicator
window.addEventListener('online',()=>document.getElementById('offlineBadge').style.display='none');
window.addEventListener('offline',()=>document.getElementById('offlineBadge').style.display='block');
if(!navigator.onLine)document.getElementById('offlineBadge').style.display='block';

// Service Worker
if('serviceWorker'in navigator)window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init(){
  // Check lockout
  if(isLocked()){startLockTimer();showView('lockoutView');return;}

  // Check if configured
  if(!isConfigured()){showView('setupView');return;}

  // Check session (tab still open)
  try{
    const s=JSON.parse(sessionStorage.getItem(K.session));
    if(s&&FAMILY[s.m]&&Date.now()-s.t<3600000){currentUser=s.m;enterApp();return;}
  }catch{}

  showView('memberView');
})();
</script>
</body>
</html>
